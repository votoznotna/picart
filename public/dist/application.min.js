"use strict";var ApplicationConfiguration=function(){var applicationModuleName="picart",applicationModuleVendorDependencies=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","ng.deviceDetector","grecaptcha"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.html5Mode(!0),$locationProvider.hashPrefix("!")}]).config(["grecaptchaProvider",function(grecaptchaProvider){grecaptchaProvider.setParameters({sitekey:window.recaptchaSiteKey,theme:"light"})}]).value("shotDelay",6e3).run(["mongolab",function(mongolab){mongolab.setApiKey(window.mongolabApiKey)}]).run(["$state","$rootScope","$location",function($state,$rootScope){$rootScope.$on("$stateChangeStart",function(){$rootScope.searchBar=!1,$rootScope.playerBar=!1})}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("common"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("exhibition",["common","imageupload"]),ApplicationConfiguration.registerModule("users"),angular.module("common").directive("fileRequired",function(){return{restrict:"A",require:"ngModel",link:function(scope,el,attrs,ngModel){el.bind("change",function(){scope.$apply(function(){ngModel.$setViewValue(el.val()),ngModel.$render()})})}}}),angular.module("common").directive("imgLazyLoad",["$window","$document","$rootScope",function($window,$document){function LazyImage(element){function isVisible(topFoldOffset,bottomFoldOffset){if(!element.is(":visible"))return!1;null===height&&(height=element.height());var top=element.offset().top,bottom=top+height;return bottomFoldOffset>=top&&top>=topFoldOffset||bottomFoldOffset>=bottom&&bottom>=topFoldOffset||topFoldOffset>=top&&bottom>=bottomFoldOffset}function render(){isRendered=!0,renderSource()}function setSource(newSource){source=newSource,isRendered&&renderSource()}function renderSource(){var elem=element[0];if(elem.src=source,elem.complete&&elem.naturalWidth&&elem.naturalHeight){var $imgTop=jQuery(elem).closest(".img-top");$imgTop.find(".img-box-player").css({opacity:1})}else jQuery(elem).closest(".img-top").find(".img-spin").css("display","block")}var source=null,isRendered=!1,height=null;return{isVisible:isVisible,render:render,setSource:setSource}}function imgOnLoad(event){var element=event.target,$element=jQuery(element),magnifyby=3.5,natHeight=element.naturalHeight,natWidth=element.naturalWidth,thumbHeight=natHeight/magnifyby,thumbWidth=natWidth/magnifyby,thumbdimensions=[thumbWidth,thumbHeight];$element.imageMagnify({vIndent:34,heightPad:-17,magnifyby:magnifyby,thumbdimensions:thumbdimensions});var $imgTop=$element.closest(".img-top");$imgTop.find(".img-spin").css("display","none"),$imgTop.find(".img-box").css({opacity:1}),$imgTop.find(".img-box-player").css({opacity:1})}function link($scope,element,attrs){var isPlayer=(attrs.slideNumber?parseInt(attrs.slideNumber):0,attrs.player?JSON.parse(attrs.player):!1),lazyImage=new LazyImage(element);isPlayer||lazyLoader.addImage(lazyImage),element.get(0).addEventListener("load",imgOnLoad),attrs.$observe("imgLazyLoad",function(newSource){lazyImage.setSource(newSource),isPlayer&&lazyImage.render()}),$scope.$on("$destroy",function(){lazyLoader.removeImage(lazyImage)})}var lazyLoader=function(){function addImage(image){images.push(image),renderTimer||startRenderTimer(),isWatchingWindow||startWatchingWindow()}function removeImage(image){for(var i=0;i<images.length;i++)if(images[i]===image){images.splice(i,1);break}images.length||(clearRenderTimer(),stopWatchingWindow())}function checkDocumentHeight(){if(!renderTimer){var currentDocumentHeight=doc.height();currentDocumentHeight!==documentHeight&&(documentHeight=currentDocumentHeight,startRenderTimer())}}function checkImages(){for(var visible=[],hidden=[],windowHeight=win.height(),scrollTop=win.scrollTop(),topFoldOffset=scrollTop,bottomFoldOffset=topFoldOffset+windowHeight,i=0;i<images.length;i++){var image=images[i];image.isVisible(topFoldOffset,bottomFoldOffset)?visible.push(image):hidden.push(image)}for(var i=0;i<visible.length;i++)visible[i].render();images=hidden,clearRenderTimer(),images.length||stopWatchingWindow()}function clearRenderTimer(){clearTimeout(renderTimer),console.log("clearRenderTimer."),renderTimer=null}function startRenderTimer(){renderTimer=setTimeout(checkImages,renderDelay),console.log("startRenderTimer.")}function startWatchingWindow(){isWatchingWindow=!0,win.on("resize.imgLazyLoad",windowChanged),win.on("scroll.imgLazyLoad",windowChanged),documentTimer=setInterval(checkDocumentHeight,documentDelay)}function stopWatchingWindow(){isWatchingWindow=!1,win.off("resize.imgLazyLoad"),win.off("scroll.imgLazyLoad"),clearInterval(documentTimer)}function windowChanged(){renderTimer||startRenderTimer()}var images=[],renderTimer=null,renderDelay=100,win=jQuery($window),doc=$document,documentHeight=doc.height(),documentTimer=null,documentDelay=2e3,isWatchingWindow=!1;return{addImage:addImage,removeImage:removeImage}}();return{link:link,restrict:"A"}}]),angular.module("common").directive("imgLoaded",function(){return{restrict:"A",link:function(scope,element){element.bind("load",function(){element.closest(".img-box").css("opacity",1)})}}}),angular.module("common").directive("onFinishRenderFilters",["$timeout",function($timeout){return{restrict:"A",link:function(scope){scope.$last===!0&&$timeout(function(){scope.$emit("ngRepeatFinished"),scope.$broadcast("ngRepeatFinished")})}}}]),angular.module("common").directive("showErrors",["$timeout",function($timeout){return{restrict:"A",require:"^form",link:function(scope,el,attrs,formCtrl){var inputEl=el[0].querySelector("[name]"),inputNgEl=angular.element(inputEl),inputName=inputNgEl.attr("name");inputNgEl.bind("blur",function(){el.toggleClass("has-error",formCtrl[inputName].$invalid)}),scope.$on("show-errors-event",function(){el.toggleClass("has-error",formCtrl[inputName].$invalid)}),scope.$on("hide-errors-event",function(){$timeout(function(){el.removeClass("has-error")},0,!1)})}}}]),angular.module("common").directive("uniqueName",["mongolab",function(mongolab){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var mongoDbCollection=attrs.mongoCollection,mongoDbName=window.dbName,getByNameSuccessHandler=function(response){response.data&&response.data.length>0?ctrl.$setValidity("uniqueName",!1):ctrl.$setValidity("uniqueName",!0)},getByNameErrorHandler=function(){ctrl.$setValidity("uniqueName",!0)};ctrl.$parsers.unshift(function(viewValue){return null!==viewValue&&void 0!==viewValue&&""!==viewValue&&mongolab.query(mongoDbName,mongoDbCollection,{q:{title_searchable:viewValue.toLowerCase()}}).then(getByNameSuccessHandler,getByNameErrorHandler),viewValue})}}}]),angular.module("common").directive("waitSpinner",["messaging","events",function(messaging,events){return{restrict:"E",replace:!0,templateUrl:"modules/common/directives/waitSpinner.html",link:function(scope,element){element.hide();var startRequestHandler=function(){element.show(),angular.element("#main").css("opacity","0.5")},endRequestHandler=function(){element.hide(),angular.element("#main").css("opacity","1.0")};scope.startHandle=messaging.subscribe(events.message._SERVER_REQUEST_STARTED_,startRequestHandler),scope.endHandle=messaging.subscribe(events.message._SERVER_REQUEST_ENDED_,endRequestHandler),scope.$on("$destroy",function(){messaging.unsubscribe(scope.startHandle),messaging.unsubscribe(scope.endHandle)})}}}]),angular.module("common").constant("events",{message:{_ADD_ERROR_MESSAGE_:"_ADD_ERROR_MESSAGE_",_CLEAR_ERROR_MESSAGES_:"_CLEAR_ERROR_MESSAGES_",_ERROR_MESSAGES_UPDATED_:"_ERROR_MESSAGES_UPDATED_",_ADD_USER_MESSAGE_:"_ADD_USER_MESSAGE_",_CLEAR_USER_MESSAGES_:"_CLEAR_USER_MESSAGES_",_USER_MESSAGES_UPDATED_:"_USER_MESSAGES_UPDATED_",_SERVER_REQUEST_STARTED_:"_SERVER_REQUEST_STARTED_",_SERVER_REQUEST_ENDED_:"_SERVER_REQUEST_ENDED_",_LOG_TRACE_:"_LOG_TRACE_",_LOG_DEBUG_:"_LOG_DEBUG_",_LOG_INFO_:"_LOG_INFO_",_LOG_WARNING_:"_LOG_WARNING_",_LOG_ERROR_:"_LOG_ERROR_",_LOG_FATAL_:"_LOG_FATAL_"}}),angular.module("common").factory("messaging",function(){var cache={},subscribe=function(topic,callback){return cache[topic]||(cache[topic]=[]),cache[topic].push(callback),[topic,callback]},publish=function(topic,args){cache[topic]&&angular.forEach(cache[topic],function(callback){callback.apply(null,args||[])})},unsubscribe=function(handle){var t=handle[0];if(cache[t])for(var x=0;x<cache[t].length;x++)cache[t][x]===handle[1]&&cache[t].splice(x,1)},service={publish:publish,subscribe:subscribe,unsubscribe:unsubscribe};return service}),angular.module("common").factory("mongolab",["$http",function($http){var apiKey="",baseUrl="https://api.mongolab.com/api/1/databases",setApiKey=function(apikey){apiKey=apikey},getApiKey=function(){return apiKey},setBaseUrl=function(uri){baseUrl=uri},getBaseUrl=function(){return baseUrl},query=function(database,collection,parameters){parameters=parameters||{},parameters.apiKey=apiKey;var uri=baseUrl+"/"+database+"/collections/"+collection;return $http({method:"GET",url:uri,params:parameters,cache:!1})},queryById=function(database,collection,id,parameters){parameters=parameters||{},parameters.apiKey=apiKey;var uri=baseUrl+"/"+database+"/collections/"+collection+"/"+id;return $http({method:"GET",url:uri,params:parameters,cache:!1})},createObject=function(database,collection,object){var uri=baseUrl+"/"+database+"/collections/"+collection+"?apiKey="+apiKey;return $http({method:"POST",url:uri,data:angular.toJson(object),cache:!1})},updateObject=function(database,collection,object){var uri=baseUrl+"/"+database+"/collections/"+collection+"/"+object._id.$oid+"?apiKey="+apiKey;return delete object._id,$http({method:"PUT",url:uri,data:angular.toJson(object),cache:!1})},deleteObject=function(database,collection,object){var uri=baseUrl+"/"+database+"/collections/"+collection+"/"+object._id.$oid+"?apiKey="+apiKey;return $http({method:"DELETE",url:uri,cache:!1})},mongolab={setApiKey:setApiKey,getApiKey:getApiKey,setBaseUrl:setBaseUrl,getBaseUrl:getBaseUrl,query:query,queryById:queryById,create:createObject,update:updateObject,"delete":deleteObject};return mongolab}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$rootScope","$scope","Authentication","Menus",function($rootScope,$scope,Authentication,Menus){$rootScope.exhibitQuery="",$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.$on("$stateChangeSuccess",function(){$scope.isCollapsed=!1}),$scope.searchExhibits=function(){$rootScope.exhibitQuery=$scope.query},$scope.clearSearch=function(){$scope.query=""},$scope.playGo=function(value){var action=value?"startPlayer":"stopPlayer";$rootScope.$broadcast(action),angular.element("body").trigger("click")},$scope.playPrev=function(){$rootScope.$broadcast("prevShot"),angular.element("body").trigger("click")},$scope.playNext=function(){$rootScope.$broadcast("nextShot"),angular.element("body").trigger("click")},$scope.signout=function(){window.location.href="/auth/signout"}}]),angular.module("core").controller("HomeController",["$scope","Authentication",function($scope,Authentication){$scope.authentication=Authentication}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var shouldRender=function(user){if(!user)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,isPublic,roles){return this.menus[menuId]={isPublic:isPublic||!1,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemType,menuItemUIRoute,isPublic,roles,position){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,menuItemType:menuItemType||"item",menuItemClass:menuItemType,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].roles:roles,position:position||0,items:[],shouldRender:shouldRender}),this.menus[menuId]},this.addSubMenuItem=function(menuId,rootMenuItemURL,menuItemTitle,menuItemURL,menuItemUIRoute,isPublic,roles,position){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===rootMenuItemURL&&this.menus[menuId].items[itemIndex].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].items[itemIndex].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].items[itemIndex].roles:roles,position:position||0,shouldRender:shouldRender});return this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.removeSubMenuItem=function(menuId,submenuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)for(var subitemIndex in this.menus[menuId].items[itemIndex].items)this.menus[menuId].items[itemIndex].items[subitemIndex].link===submenuItemURL&&this.menus[menuId].items[itemIndex].items.splice(subitemIndex,1);return this.menus[menuId]},this.addMenu("topbar",!0)}]),angular.module("exhibition").run(["Menus",function(Menus){Menus.addMenuItem("topbar","Exhibition","exhibition",null,null,!0),Menus.addMenuItem("topbar","Player","player",null,null,!0),Menus.addMenuItem("topbar","New Exhibit","exhibition/create",null,null,!1)}]),angular.module("exhibition").config(["$stateProvider",function($stateProvider){$stateProvider.state("exhibition",{url:"/exhibition",templateUrl:"modules/exhibition/views/list-exhibition.client.view.html"}).state("player",{url:"/player",templateUrl:"modules/exhibition/views/player-exhibition.client.view.html"}).state("createExhibit",{url:"/exhibition/create",templateUrl:"modules/exhibition/views/create-exhibit.client.view.html"}).state("viewExhibit",{url:"/exhibition/:exhibitId",templateUrl:"modules/exhibition/views/view-exhibit.client.view.html"}).state("editExhibit",{url:"/exhibition/:exhibitId/edit",templateUrl:"modules/exhibition/views/edit-exhibit.client.view.html"})}]),angular.module("exhibition").controller("RemoveExhibitionConfirmationController",["$rootScope","$scope","$modalInstance","exhibitName",function($rootScope,$scope,$modalInstance,exhibitName){$scope.exhibitName=exhibitName,$scope.ok=function(){$modalInstance.close(!0)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("exhibition").controller("ExhibitionController",["$rootScope","$scope","$filter","$modal","$document","$timeout","$stateParams","$state","$http","$window","Authentication","Exhibition","ExhibitMagnify","messaging","events","shotDelay","deviceDetector",function($rootScope,$scope,$filter,$modal,$document,$timeout,$stateParams,$state,$http,$window,Authentication,Exhibition,ExhibitMagnify,messaging,events,shotDelay,deviceDetector){function GetFilename(url){if(url){var pattern=/(?=\w+\.\w{3,4}$).+/,m=pattern.exec(url.toString());if(m&&m.length>0)return m[0]}return""}function enableShot(){jQuery(".rotator").eq($rootScope.slideIndex).css({opacity:1})}function incShot(){$rootScope.slideIndex=$rootScope.slideIndex==$rootScope.slidesLength-1?0:$rootScope.slideIndex+1,enableShot()}function decShot(){$rootScope.slideIndex=0==$rootScope.slideIndex?$rootScope.slidesLength-1:$rootScope.slideIndex-1,enableShot()}function nextShotProc(){$rootScope.slideIndex=$rootScope.slideIndex==$rootScope.slidesLength-1?0:$rootScope.slideIndex+1,jQuery(".rotator").eq($rootScope.slideIndex).animate({opacity:1},300,function(){timer=$timeout(nextShot,shotDelay)})}function nextShot(){jQuery(".rotator").eq($rootScope.slideIndex).animate({opacity:0},300,function(){timerNext=$timeout(nextShotProc,0)})}function removeTimers(){$timeout.cancel(timer),$timeout.cancel(timerNext)}var timer=null,timerNext=null;$rootScope.searchBar="exhibition"===$state.current.name.toLowerCase()?!0:!1,$rootScope.playerBar="player"===$state.current.name.toLowerCase()?!0:!1,$rootScope.urlRoot=$window.urlRoot,$scope.oddBrowser=function(){return deviceDetector.raw.browser.ie||deviceDetector.raw.browser.firefox},$scope.master={},$scope.recaptcha=null,$rootScope.playerActive=!1,$rootScope.slideIndex=0,$rootScope.slidesLength=0,$scope.exhibit=angular.copy($scope.master),$scope.authentication=Authentication,$scope.save=function(isUpdate){if($scope.$broadcast("show-errors-event"),!$scope.exhibitForm.$invalid){var formData=new FormData;isUpdate?($scope.exhibit.newPicture&&formData.append("image",$scope.exhibit.newPicture.file),formData.append("_id",$scope.exhibit._id)):formData.append("image",$scope.exhibit.picture.file),formData.append("title",$scope.exhibit.title),formData.append("content",$scope.exhibit.content?$scope.exhibit.content:""),formData.append("recaptcha",$scope.recaptcha),messaging.publish(events.message._SERVER_REQUEST_STARTED_),$http.post("upload",formData,{headers:{"Content-Type":void 0},transformRequest:angular.identity}).then(function(){$state.go("exhibition")},function(result){$scope.hasFormError=!0,$scope.formErrors=result&&result.data.message?result.data.message?result.data.message:result.statusText:"Unknown error"})["finally"](function(){messaging.publish(events.message._SERVER_REQUEST_ENDED_)})}},$scope.getPic=function(pic){return"data:"+pic.mime+";base64,"+btoa(pic.data)},$scope.remove=function(exhibit){if(exhibit){exhibit.$remove();for(var i in $scope.exhibition)$scope.exhibition[i]===exhibit&&$scope.exhibition.splice(i,1)}else $scope.exhibit.$remove(function(){$state.go("exhibition")})},$scope["delete"]=function(){var formData=new FormData;formData.append("_id",$scope.exhibit._id),formData.append("recaptcha",$scope.recaptcha),messaging.publish(events.message._SERVER_REQUEST_STARTED_),$http.post("delete",formData,{headers:{"Content-Type":void 0},transformRequest:angular.identity}).then(function(){for(var ind in $scope.exhibition)$scope.exhibition[ind]===$scope.exhibit&&$scope.exhibition.splice(ind,1);$state.go("exhibition")},function(result){$scope.hasFormError=!0,$scope.formErrors=result&&result.data.message?result.data.message?result.data.message:result.statusText:"Unknown error"})["finally"](function(){messaging.publish(events.message._SERVER_REQUEST_ENDED_)})},$scope.find=function(){$scope.exhibition=Exhibition.query(),$scope.exhibition.$promise.then(function(data){$rootScope.slidesLength=$filter("picRequired")(data).length,$rootScope.playerBar&&$scope.startPlay()})},$scope.findOne=function(){$scope.exhibit=Exhibition.get({exhibitId:$stateParams.exhibitId}),$scope.exhibit.$promise.then(function(data){$scope.master=angular.copy(data),jQuery("#uploadNewFile").val(data.pic.name)})},$scope.cancelForm=function(){$state.go("exhibition")},$scope.resetForm=function(isUpdate){$scope.$broadcast("hide-errors-event"),$scope.clearPicture(isUpdate),$scope.exhibit=angular.copy($scope.master),$scope.hasFormError=!1,$scope.formErrors=null,$scope.exhibitForm.$setPristine(),$scope.exhibitForm.$setUntouched(),$scope.exhibit.pic.name&&jQuery("#uploadNewFile").val($scope.exhibit.pic.name)},$scope.clearPicture=function(isUpdate){isUpdate?($scope.exhibit.newPicture=null,angular.element(document.querySelector("#newPicture")).val(""),angular.element(document.querySelector("#uploadNewFile")).val("")):($scope.exhibit.picture=null,angular.element(document.querySelector("#picture")).val(""),angular.element(document.querySelector("#uploadFile")).val(""))},document.getElementById("picture")&&(document.getElementById("picture").onchange=function(){document.getElementById("uploadFile").value=GetFilename(this.value),messaging.publish(events.message._SERVER_REQUEST_STARTED_)}),document.getElementById("newPicture")&&(document.getElementById("newPicture").onchange=function(){document.getElementById("uploadNewFile").value=GetFilename(this.value),messaging.publish(events.message._SERVER_REQUEST_STARTED_)}),$scope.$on("serverRequestEnded",function(){$scope.endUpload()}),$scope.endUpload=function(){messaging.publish(events.message._SERVER_REQUEST_ENDED_)},$scope.deleteConfirmation=function(){var modalInstance=$modal.open({templateUrl:"deleteExhibitConfirmation.html",controller:"RemoveExhibitionConfirmationController",size:"sm",resolve:{exhibitName:function(){return $scope.exhibit.title}}});modalInstance.result.then(function(isConfirmed){isConfirmed&&$scope["delete"]()},function(){})},$scope.startPlay=function(){$rootScope.playerActive=!0,timer=$timeout(nextShot,shotDelay)},$scope.$on("startPlayer",function(){$scope.startPlay()}),$scope.stopPlay=function(){removeTimers(),$rootScope.playerActive=!1},$scope.togglePlay=function(){$rootScope.playerActive?$scope.stopPlay():$scope.startPlay()},$scope.$on("stopPlayer",function(){$rootScope.playerActive=!1,removeTimers()}),$scope.$on("prevShot",function(){removeTimers(),$rootScope.playerActive=!1,decShot()}),$scope.$on("nextShot",function(){removeTimers(),$rootScope.playerActive=!1,incShot()}),$scope.$on("$destroy",function(){removeTimers()})}]),angular.module("common").filter("picRequired",function(){return function(items){for(var filtered=[],i=0;i<items.length;i++){var item=items[i];item.pic.size&&filtered.push(item)}return filtered}}),angular.module("exhibition").factory("Exhibition",["$resource",function($resource){return $resource("exhibition/:exhibitId",{exhibitId:"@_id"},{update:{method:"PUT"}})}]),angular.module("exhibition").factory("ExhibitMagnify",["$timeout",function($timeout){function runMagnify(elements,pollingInterval,magnifyby){var loadingCount=0;elements.each(function(){var domImg=jQuery(this).get(0);if(domImg.complete===!1||0===domImg.naturalHeight||0===domImg.naturalWidth)loadingCount++;else{var natHeight=domImg.naturalHeight,natWidth=domImg.naturalWidth,thumbHeight=natHeight/magnifyby,thumbWidth=natWidth/magnifyby,thumbdimensions=[thumbWidth,thumbHeight];jQuery(this).imageMagnify({vIndent:50,hIndent:0,magnifyby:magnifyby,thumbdimensions:thumbdimensions})}}),loadingCount&&$timeout(function(){runMagnify(elements,pollingInterval,magnifyby)},pollingInterval)}return{runMagnify:runMagnify}}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("accounts",{url:"/settings/accounts",templateUrl:"modules/users/views/settings/social-accounts.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/authentication/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$location","Authentication",function($scope,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.href=function(href){$location.path(href)},$scope.signup=function(){$http.post("/auth/signup",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})},$scope.signin=function(){$http.post("/auth/signin",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function($scope,$stateParams,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.askForPasswordReset=function(){$scope.success=$scope.error=null,$http.post("/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message}).error(function(response){$scope.credentials=null,$scope.error=response.message})},$scope.resetUserPassword=function(){$scope.success=$scope.error=null,$http.post("/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.passwordDetails=null,Authentication.user=response,$location.path("/password/reset/success")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication",function($scope,$http,$location,Users,Authentication){$scope.user=Authentication.user,$scope.user||$location.path("/"),$scope.hasConnectedAdditionalSocialAccounts=function(){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http["delete"]("/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.updateUserProfile=function(isValid){if(isValid){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response},function(response){$scope.error=response.data.message})}else $scope.submitted=!0},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(){$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})}}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]),angular.module("imageupload",["common"]).directive("image",["$q","messaging","events",function($q,messaging,events){var URL=window.URL||window.webkitURL,getResizeArea=function(){var resizeAreaId="fileupload-resize-area",resizeArea=document.getElementById(resizeAreaId);return resizeArea||(resizeArea=document.createElement("canvas"),resizeArea.id=resizeAreaId,resizeArea.style.visibility="hidden",document.body.appendChild(resizeArea)),resizeArea},resizeImage=function(origImage,options){var maxHeight=options.resizeMaxHeight||300,maxWidth=options.resizeMaxWidth||250,quality=options.resizeQuality||.7,type=options.resizeType||"image/jpg",canvas=getResizeArea(),height=origImage.height,width=origImage.width;width>height?width>maxWidth&&(height=Math.round(height*=maxWidth/width),width=maxWidth):height>maxHeight&&(width=Math.round(width*=maxHeight/height),height=maxHeight),canvas.width=width,canvas.height=height;var ctx=canvas.getContext("2d");return ctx.drawImage(origImage,0,0,width,height),canvas.toDataURL(type,quality)},createImage=function(url,callback){var image=new Image;image.onload=function(){callback(image)},image.src=url},fileToDataURL=function(file){var deferred=$q.defer(),reader=new FileReader;return reader.onload=function(e){deferred.resolve(e.target.result)},reader.readAsDataURL(file),deferred.promise};return{restrict:"A",scope:{image:"=",resizeMaxHeight:"@?",resizeMaxWidth:"@?",resizeQuality:"@?",resizeType:"@?"},link:function(scope,element,attrs){var doResizing=function(imageResult,callback){createImage(imageResult.url,function(image){var dataURL=resizeImage(image,scope);imageResult.resized={dataURL:dataURL,type:dataURL.match(/:(.+\/.+);/)[1]},callback(imageResult)})},applyScope=function(imageResult){scope.$apply(function(){messaging.publish(events.message._SERVER_REQUEST_ENDED_),attrs.multiple?scope.image.push(imageResult):scope.image=imageResult})};element.bind("change",function(evt){attrs.multiple&&(scope.image=[]);for(var files=evt.target.files,i=0;i<files.length;i++){var imageResult={file:files[i],url:URL.createObjectURL(files[i])};fileToDataURL(files[i]).then(function(dataURL){imageResult.dataURL=dataURL}),scope.resizeMaxHeight||scope.resizeMaxWidth?doResizing(imageResult,function(imageResult){applyScope(imageResult)}):applyScope(imageResult)}})}}}]),jQuery.noConflict(),jQuery.imageMagnify={dsettings:{windowFit:!0,vIndent:0,hIndent:0,heightPad:0,widthPad:0,magnifyby:3,duration:500,imgopacity:.2},cursorcss:"url(/modules/common/js/magnify/magnify.cur), -moz-zoom-in",zIndexcounter:100,refreshoffsets:function($window,$target,warpshell){var $offsets=$target.offset(),winattrs={x:$window.scrollLeft(),y:$window.scrollTop(),w:$window.width(),h:$window.height()};warpshell.attrs.x=$offsets.left,warpshell.attrs.y=$offsets.top,warpshell.newattrs.x=winattrs.x+winattrs.w/2-warpshell.newattrs.w/2,warpshell.newattrs.y=winattrs.y+winattrs.h/2-warpshell.newattrs.h/2,warpshell.newattrs.x<winattrs.x+5?warpshell.newattrs.x=winattrs.x+5:warpshell.newattrs.x+warpshell.newattrs.w>winattrs.x+winattrs.w&&(warpshell.newattrs.x=winattrs.x+5),warpshell.newattrs.y<winattrs.y+5&&(warpshell.newattrs.y=winattrs.y+5)},refreshSize:function($window,$target,imageinfo,setting){var element=$target.get(0),natHeight=element.naturalHeight,natWidth=element.naturalWidth;natHeight>=natWidth?(imageinfo.newattrs.h=natHeight<$window.height()-setting.vIndent?natHeight:$window.height()-setting.vIndent,imageinfo.newattrs.w=imageinfo.newattrs.h*natWidth/natHeight,imageinfo.newattrs.w>$window.width()&&(imageinfo.newattrs.w=imageinfo.newattrs.w<$window.width()-setting.hIndent?imageinfo.newattrs.w:$window.width()-setting.hIndent,imageinfo.newattrs.h=imageinfo.newattrs.w*natHeight/natWidth)):(imageinfo.newattrs.w=natWidth<$window.width()-setting.hIndent?natWidth:$window.width()-setting.hIndent,imageinfo.newattrs.h=imageinfo.newattrs.w*natHeight/natWidth,imageinfo.newattrs.h>$window.height()-setting.vIndent&&(imageinfo.newattrs.h=imageinfo.newattrs.h<$window.height()-setting.vIndent?imageinfo.newattrs.h:$window.height()-setting.vIndent,imageinfo.newattrs.w=imageinfo.newattrs.h*natWidth/natHeight))
},magnify:function($,$target,options){var setting={},setting=jQuery.extend(setting,this.dsettings,options),attrs=options.thumbdimensions?{w:options.thumbdimensions[0],h:options.thumbdimensions[1]}:{w:$target.outerWidth(),h:$target.outerHeight()},newattrs={};$target.data("imgshell")&&($target.data("imgshell").$clone.remove(),$target.css({opacity:1}).unbind("click.magnify"));var $clone=$target.clone().css({position:"absolute",left:0,top:0,display:"none",border:"1px solid gray",cursor:"pointer"}).appendTo(document.body);$clone.data("$relatedtarget",$target),$clone.data("$zoomOutProgress","0"),$clone.data("$zoomStatus","0"),$target.data("imgshell",{$clone:$clone,attrs:attrs,newattrs:newattrs}),$target.bind("click.magnify",function(){var $this=$(this).css({opacity:setting.imgopacity}),imageinfo=$this.data("imgshell");if(imageinfo){jQuery.imageMagnify.refreshSize($(window),$this,imageinfo,setting),jQuery.imageMagnify.refreshoffsets($(window),$this,imageinfo);var $clone=imageinfo.$clone;$clone.data("$zoomStatus","0"),$("body").on("click",function(e){$clone.css("opacity");e.target!==$clone.get(0)&&"1"==$clone.data("$zoomStatus")&&"0"==$clone.data("$zoomOutProgress")&&$clone.trigger("click")}),$(window).on("click scroll resize",function(e){$clone.css("opacity");e.target!==$clone.get(0)&&"1"==$clone.data("$zoomStatus")&&"0"==$clone.data("$zoomOutProgress")&&$clone.trigger("click")}),$clone.stop().css({zIndex:++jQuery.imageMagnify.zIndexcounter,left:imageinfo.attrs.x,top:imageinfo.attrs.y,width:imageinfo.attrs.w,height:imageinfo.attrs.h,opacity:0,display:"block"}).animate({opacity:1,left:$(window).width()===imageinfo.newattrs.w?0:imageinfo.newattrs.x+setting.hIndent,top:imageinfo.newattrs.y+setting.vIndent,width:imageinfo.newattrs.w+setting.widthPad,height:imageinfo.newattrs.h+setting.heightPad},setting.duration,function(){$clone.data("$zoomStatus","1")})}}),$clone.on("click",function(){var $=jQuery,$this=$(this),imageinfo=$this.data("$relatedtarget").data("imgshell");imageinfo&&($this.data("$zoomOutProgress","1"),jQuery.imageMagnify.refreshSize($(window),$this,imageinfo,setting),jQuery.imageMagnify.refreshoffsets($(window),$this.data("$relatedtarget"),imageinfo),$this.stop().animate({opacity:0,left:imageinfo.attrs.x,top:imageinfo.attrs.y+setting.vIndent,width:imageinfo.attrs.w,height:imageinfo.attrs.h},setting.duration,function(){$this.hide(),$this.data("$relatedtarget").css({opacity:1}),$this.data("$zoomOutProgress","0"),$clone.data("$zoomStatus","0")}))})}},jQuery.fn.imageMagnify=function(options){var $=jQuery;return this.each(function(){var $imgref=$(this);return this.tagName&&"IMG"!=this.tagName.toUpperCase()?!0:void(parseInt($imgref.css("width"))>0&&parseInt($imgref.css("height"))>0||options.windowFit||options.thumbdimensions?jQuery.imageMagnify.magnify($,$imgref,options):this.complete?jQuery.imageMagnify.magnify($,$imgref,options):$(this).bind("load",function(){jQuery.imageMagnify.magnify($,$imgref,options)}))})},jQuery.fn.applyMagnifier=function(){var $=jQuery;return this.each(function(){$(this);return this.tagName&&"IMG"!=this.tagName.toUpperCase()?!0:void 0})},jQuery(document).ready(function($){var $targets=$(".magnify");$targets.each(function(){var $target=$(this),options={};$target.attr("data-magnifyto")&&(options.magnifyto=parseFloat($target.attr("data-magnifyto"))),$target.attr("data-magnifyby")&&(options.magnifyby=parseFloat($target.attr("data-magnifyby"))),$target.attr("data-magnifyduration")&&(options.duration=parseInt($target.attr("data-magnifyduration"))),$target.imageMagnify(options)});var $triggers=$('a[rel^="magnify["]');$triggers.each(function(){var $trigger=$(this),targetid=$trigger.attr("rel").match(/\[.+\]/)[0].replace(/[\[\]']/g,"");$trigger.data("magnifyimageid",targetid),$trigger.click(function(e){$("#"+$(this).data("magnifyimageid")).trigger("click.magnify"),e.preventDefault()})})});